name: Build and Release

on:
    push:
        tags:
            - 'v*'
    workflow_dispatch:
        inputs:
            build_desktop:
                description: 'Build desktop platforms (macOS/Windows/Linux)'
                required: false
                default: true
                type: boolean
            build_android:
                description: 'Build Android platform'
                required: false
                default: true
                type: boolean

permissions:
    contents: write

jobs:
    # ==================== Desktop Build ====================
    build-desktop:
        if: ${{ github.event_name == 'push' || inputs.build_desktop }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    - platform: 'macos-15'
                      args: '--target x86_64-apple-darwin'
                      target: 'x86_64-apple-darwin'
                      arch: 'x64'
                    - platform: 'macos-14'
                      args: '--target aarch64-apple-darwin'
                      target: 'aarch64-apple-darwin'
                      arch: 'aarch64'
                    - platform: 'ubuntu-22.04'
                      args: ''
                      target: ''
                      arch: 'x64'
                    - platform: 'windows-latest'
                      args: ''
                      target: ''
                      arch: 'x64'

        runs-on: ${{ matrix.platform }}
        name: Build (${{ matrix.platform }}${{ matrix.arch != 'x64' && format('-{0}', matrix.arch) || '' }})

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: lts/*
                  cache: 'pnpm'

            - name: Install Rust stable
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.platform == 'macos-15' && 'x86_64-apple-darwin' || matrix.platform == 'macos-14' && 'aarch64-apple-darwin' || '' }}

            - name: Cache Rust build artifacts
              uses: swatinem/rust-cache@v2
              with:
                  workspaces: './src-tauri -> target'
                  cache-on-failure: true

            - name: Install Dependencies (Ubuntu only)
              if: matrix.platform == 'ubuntu-22.04'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

            - name: Install frontend dependencies
              run: pnpm install

            - name: Build Tauri app
              uses: tauri-apps/tauri-action@v0.6.1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tagName: ${{ github.ref_name }}
                  releaseName: 'PureSend v__VERSION__'
                  releaseBody: 'See the assets to download this version and install.'
                  releaseDraft: true
                  prerelease: false
                  args: ${{ matrix.args }}

    # ==================== Android Build ====================
    build-android:
        if: ${{ github.event_name == 'push' || inputs.build_android }}
        runs-on: ubuntu-22.04
        name: Build (Android)
        env:
            HAS_KEYSTORE: ${{ secrets.BASE64_JKS != '' }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: lts/*
                  cache: 'pnpm'

            - name: Install Rust stable
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android

            - name: Cache Rust build artifacts
              uses: swatinem/rust-cache@v2
              with:
                  workspaces: './src-tauri -> target'
                  cache-on-failure: true

            - name: Install Linux dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libgtk-3-dev libpango1.0-dev libatk1.0-dev

            - name: Setup Java
              uses: actions/setup-java@v4
              with:
                  distribution: 'temurin'
                  java-version: '17'

            - name: Setup Android SDK
              uses: android-actions/setup-android@v3

            - name: Install NDK
              uses: nttld/setup-ndk@v1
              with:
                  ndk-version: ${{ secrets.NDK_VERSION || 'r27c' }}
                  add-to-path: true

            - name: Decode keystore
              if: ${{ env.HAS_KEYSTORE == 'true' }}
              run: |
                  mkdir -p $HOME/.android
                  echo "${{ secrets.BASE64_JKS }}" | base64 --decode > $HOME/.android/upload-keystore.jks

            - name: Install frontend dependencies
              run: pnpm install

            - name: Initialize Tauri Android project
              run: pnpm tauri android init
              env:
                  NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
                  ANDROID_HOME: ${{ env.ANDROID_HOME }}

            - name: Update app icons
              run: pnpm tauri icon src-tauri/icons/icon-source.png

            - name: Inject Android signing configuration
              if: ${{ env.HAS_KEYSTORE == 'true' }}
              run: |
                  # Create keystore.properties
                  cat > src-tauri/gen/android/keystore.properties << EOF
                  storePassword=${{ secrets.STORE_PASSWORD }}
                  keyPassword=${{ secrets.KEY_PASSWORD }}
                  keyAlias=${{ secrets.KEY_ALIAS }}
                  storeFile=$HOME/.android/upload-keystore.jks
                  EOF

                  # Inject signing config into app/build.gradle.kts using Python for reliability
                  python3 << 'PYEOF'
                  import re

                  gradle_file = "src-tauri/gen/android/app/build.gradle.kts"
                  with open(gradle_file, "r") as f:
                      content = f.read()

                  # Add imports only if not already present
                  imports_to_add = []
                  if "import java.util.Properties" not in content:
                      imports_to_add.append("import java.util.Properties")
                  if "import java.io.FileInputStream" not in content:
                      imports_to_add.append("import java.io.FileInputStream")
                  if imports_to_add:
                      content = "\n".join(imports_to_add) + "\n\n" + content

                  # Inject signingConfigs block after "android {" if not already present
                  signing_block = """
                      signingConfigs {
                          create("release") {
                              val keystorePropertiesFile = rootProject.file("keystore.properties")
                              val keystoreProperties = Properties()
                              if (keystorePropertiesFile.exists()) {
                                  keystoreProperties.load(FileInputStream(keystorePropertiesFile))
                              }
                              keyAlias = keystoreProperties["keyAlias"] as String? ?: ""
                              keyPassword = keystoreProperties["keyPassword"] as String? ?: ""
                              storeFile = if (keystoreProperties["storeFile"] != null) file(keystoreProperties["storeFile"] as String) else null
                              storePassword = keystoreProperties["storePassword"] as String? ?: ""
                          }
                      }
                  """
                  if "signingConfigs" not in content:
                      content = content.replace("android {", "android {" + signing_block, 1)

                  # Update release buildType to use release signing config
                  content = content.replace(
                      'signingConfig = signingConfigs.getByName("debug")',
                      'signingConfig = signingConfigs.getByName("release")'
                  )

                  with open(gradle_file, "w") as f:
                      f.write(content)

                  print("Signing configuration injected successfully")
                  PYEOF

            - name: Build Tauri Android APK
              run: pnpm tauri android build --apk
              env:
                  NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
                  ANDROID_HOME: ${{ env.ANDROID_HOME }}

            - name: Sign APK if unsigned
              run: |
                  # Find the built APK
                  APK_PATH=$(find src-tauri/gen/android/app/build/outputs/apk -name '*.apk' | head -1)
                  echo "Found APK: $APK_PATH"

                  if [ -z "$APK_PATH" ]; then
                    echo "Error: No APK found"
                    exit 1
                  fi

                  # Find build-tools directory for apksigner and zipalign
                  BUILD_TOOLS_DIR=$(ls -d $ANDROID_HOME/build-tools/*/ | sort -V | tail -1)
                  echo "Using build-tools: $BUILD_TOOLS_DIR"

                  # Check if APK is unsigned
                  if echo "$APK_PATH" | grep -q "unsigned"; then
                    echo "APK is unsigned, signing with debug keystore..."

                    # Generate a debug keystore if it doesn't exist
                    DEBUG_KEYSTORE="$HOME/.android/debug.keystore"
                    if [ ! -f "$DEBUG_KEYSTORE" ]; then
                      keytool -genkey -v -keystore "$DEBUG_KEYSTORE" \
                        -storepass android -alias androiddebugkey -keypass android \
                        -keyalg RSA -keysize 2048 -validity 10000 \
                        -dname "CN=Android Debug,O=Android,C=US"
                    fi

                    # Zipalign the APK first
                    ALIGNED_APK="${APK_PATH%.apk}-aligned.apk"
                    ${BUILD_TOOLS_DIR}zipalign -v 4 "$APK_PATH" "$ALIGNED_APK"

                    # Sign with debug keystore
                    ${BUILD_TOOLS_DIR}apksigner sign \
                      --ks "$DEBUG_KEYSTORE" \
                      --ks-pass pass:android \
                      --ks-key-alias androiddebugkey \
                      --key-pass pass:android \
                      --out "${APK_PATH/unsigned/signed}" \
                      "$ALIGNED_APK"

                    # Remove intermediate files, keep signed APK
                    rm -f "$ALIGNED_APK"
                    echo "Signed APK: ${APK_PATH/unsigned/signed}"
                  else
                    echo "APK is already signed"
                  fi

                  # List final APK files
                  find src-tauri/gen/android/app/build/outputs/apk -name '*.apk' -exec ls -la {} \;

            - name: Upload Android artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: android-artifacts
                  path: |
                      src-tauri/gen/android/app/build/outputs/apk/**/*.apk
                      src-tauri/gen/android/app/build/outputs/bundle/**/*.aab
                  retention-days: 30

    # ==================== Create Release ====================
    create-release:
        needs: [build-desktop, build-android]
        if: startsWith(github.ref, 'refs/tags/v')
        runs-on: ubuntu-latest
        name: Create Release

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: List artifacts
              run: find artifacts -type f | head -50

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  name: PureSend ${{ github.ref_name }}
                  body: |
                      ## Downloads

                      ### Desktop
                      - **macOS (Intel)**: Download the `.dmg` file
                      - **macOS (Apple Silicon)**: Download the `.dmg` file
                      - **Windows**: Download the `.msi` or `.exe` (NSIS installer)
                      - **Linux**: Download the `.deb`, `.AppImage`, or `.rpm` file

                      ### Android
                      - Download the `.apk` file for installation

                      ## Changes
                      See the commit history for details.
                  draft: true
                  prerelease: false
                  generate_release_notes: true
                  files: |
                      artifacts/**/*
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
