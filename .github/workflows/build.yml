name: Build and Release

on:
    push:
        tags:
            - 'v*'
    workflow_dispatch:
        inputs:
            build_desktop:
                description: 'Build desktop platforms (macOS/Windows/Linux)'
                required: false
                default: true
                type: boolean
            # Android 构建暂时禁用，后续稳定后再启用
            # build_android:
            #     description: 'Build Android platform'
            #     required: false
            #     default: true
            #     type: boolean

permissions:
    contents: write

jobs:
    # ==================== Desktop Build ====================
    build-desktop:
        if: ${{ github.event_name == 'push' || inputs.build_desktop }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    - platform: 'macos-15'
                      args: '--target x86_64-apple-darwin'
                      target: 'x86_64-apple-darwin'
                      arch: 'x64'
                    - platform: 'macos-14'
                      args: '--target aarch64-apple-darwin'
                      target: 'aarch64-apple-darwin'
                      arch: 'aarch64'
                    - platform: 'ubuntu-22.04'
                      args: ''
                      target: ''
                      arch: 'x64'
                    - platform: 'windows-latest'
                      args: ''
                      target: ''
                      arch: 'x64'

        runs-on: ${{ matrix.platform }}
        name: Build (${{ matrix.platform }}${{ matrix.arch != 'x64' && format('-{0}', matrix.arch) || '' }})

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: lts/*
                  cache: 'pnpm'

            - name: Install Rust stable
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.platform == 'macos-15' && 'x86_64-apple-darwin' || matrix.platform == 'macos-14' && 'aarch64-apple-darwin' || '' }}

            - name: Cache Rust build artifacts
              uses: swatinem/rust-cache@v2
              with:
                  workspaces: './src-tauri -> target'
                  cache-on-failure: true

            - name: Install Dependencies (Ubuntu only)
              if: matrix.platform == 'ubuntu-22.04'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

            - name: Install frontend dependencies
              run: pnpm install

            - name: Build Tauri app
              uses: tauri-apps/tauri-action@v0.6.1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tagName: ${{ github.ref_name }}
                  releaseName: 'PureSend v__VERSION__'
                  releaseBody: 'See the assets to download this version and install.'
                  releaseDraft: true
                  prerelease: false
                  args: ${{ matrix.args }}

    # ==================== Android Build ====================
    # Android 构建暂时禁用，后续稳定后再启用
    # build-android:
    #     if: ${{ github.event_name == 'push' || inputs.build_android }}
    #     runs-on: ubuntu-22.04
    #     name: Build (Android)
    #
    #     steps:
    #         - name: Checkout repository
    #           uses: actions/checkout@v4
    #
    #         - name: Setup pnpm
    #           uses: pnpm/action-setup@v4
    #           with:
    #               version: 9
    #
    #         - name: Setup Node.js
    #           uses: actions/setup-node@v4
    #           with:
    #               node-version: lts/*
    #               cache: 'pnpm'
    #
    #         - name: Install Rust stable
    #           uses: dtolnay/rust-toolchain@stable
    #           with:
    #               targets: aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android
    #
    #         - name: Cache Rust build artifacts
    #           uses: swatinem/rust-cache@v2
    #           with:
    #               workspaces: './src-tauri -> target'
    #               cache-on-failure: true
    #
    #         - name: Install Linux dependencies
    #           run: |
    #               sudo apt-get update
    #               sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libgtk-3-dev libpango1.0-dev libatk1.0-dev
    #
    #         - name: Setup Java
    #           uses: actions/setup-java@v4
    #           with:
    #               distribution: 'temurin'
    #               java-version: '17'
    #
    #         - name: Setup Android SDK
    #           uses: android-actions/setup-android@v3
    #
    #         - name: Install NDK
    #           run: |
    #               # 使用 GitHub runner 预装的 NDK 路径
    #               echo "NDK_HOME=/usr/local/lib/android/sdk/ndk/29.0.14206865" >> $GITHUB_ENV
    #               echo "ANDROID_HOME=/usr/local/lib/android/sdk" >> $GITHUB_ENV
    #
    #         - name: Install frontend dependencies
    #           run: pnpm install
    #
    #         - name: Build Tauri Android app
    #           run: pnpm tauri android build
    #           env:
    #               NDK_HOME: ${{ env.NDK_HOME }}
    #               ANDROID_HOME: ${{ env.ANDROID_HOME }}
    #
    #         - name: Upload Android artifacts
    #           uses: actions/upload-artifact@v4
    #           with:
    #                   name: android-artifacts
    #                   path: |
    #                       src-tauri/gen/android/app/build/outputs/apk/**/*.apk
    #                       src-tauri/gen/android/app/build/outputs/bundle/**/*.aab
    #                   retention-days: 30

    # ==================== Create Release ====================
    create-release:
        needs: [build-desktop]
        if: startsWith(github.ref, 'refs/tags/v')
        runs-on: ubuntu-latest
        name: Create Release

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: List artifacts
              run: find artifacts -type f | head -50

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  name: PureSend ${{ github.ref_name }}
                  body: |
                      ## Downloads

                      ### Desktop
                      - **macOS (Intel)**: Download the `.dmg` file
                      - **macOS (Apple Silicon)**: Download the `.dmg` file
                      - **Windows**: Download the `.msi` or `.exe` (NSIS installer)
                      - **Linux**: Download the `.deb`, `.AppImage`, or `.rpm` file

                      ### Android
                      - Download the `.apk` file for installation

                      ## Changes
                      See the commit history for details.
                  draft: true
                  prerelease: false
                  generate_release_notes: true
                  files: |
                      artifacts/**/*
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
